<?phpdefined('BASEPATH') OR exit('No direct script access allowed');class Places extends CI_Controller {	/**	 * Index Page for this controller.	 *	 * Maps to the following URL	 * 		http://example.com/index.php/welcome	 *	- or -	 * 		http://example.com/index.php/welcome/index	 *	- or -	 * Since this controller is set as the default controller in	 * config/routes.php, it's displayed at http://example.com/	 *	 * So any other public methods not prefixed with an underscore will	 * map to /index.php/welcome/<method_name>	 * @see http://codeigniter.com/user_guide/general/urls.html	 */	function __construct()    {		parent::__construct();		$this->mysystem = $this->Admin_mo->getrow('system',array('id'=>'1'));	    if(!$this->session->userdata('uid'))	    { 			redirect('home');	    }		else		{			$this->loginuser = $this->Admin_mo->getrowjoinLeftLimit('users.*,usertypes.privileges as privileges,langs.dir as dir','users',array('usertypes'=>'users.utid=usertypes.id','langs'=>'users.lang=langs.code'),array('users.id'=>$this->session->userdata('uid')),'');			$this->sections = array();			$sections = $this->Admin_mo->getwhere('sections',array('active'=>'1'));			if(!empty($sections))			{				foreach($sections as $section) { $this->sections[$section->id] = $section->code; }			}		}	}	public function index()	{		if(strpos($this->loginuser->privileges, ',pcsee,') !== false && in_array('PC',$this->sections))		{		$data['admessage'] = '';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->lang, $this->loginuser->lang);		$this->config->set_item('language', $this->loginuser->lang);		$employees = $this->Admin_mo->get('users'); foreach($employees as $employee) { $data['employees'][$employee->id] = $employee->username; }		$preporders = $this->Admin_mo->get('places');				if(!empty($preporders))		{			for($i=0;$i<count($preporders);$i++)			{				//$data['orders'][$data['preporders'][$i]->oid] = new stdClass();				$data['places'][$preporders[$i]->id]['id'] = $preporders[$i]->id;				$data['places'][$preporders[$i]->id]['title'] = $preporders[$i]->title;								$data['places'][$preporders[$i]->id]['parent'] = $preporders[$i]->parent;				$data['places'][$preporders[$i]->id]['uid'] = $preporders[$i]->uid;				$data['places'][$preporders[$i]->id]['time'] = $preporders[$i]->time;				$data['places'][$preporders[$i]->id]['active'] = $preporders[$i]->active;			}		}		$this->load->view('calenderdate');		$this->load->view('headers/places',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/places',$data);		$this->load->view('footers/places');		$this->load->view('messages');		}		else		{		$data['title'] = 'places';		$data['admessage'] = 'youhavenoprivls';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->lang, $this->loginuser->lang);		$this->config->set_item('language', $this->loginuser->lang);		$this->load->view('headers/places',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/messages',$data);		$this->load->view('footers/places');		$this->load->view('messages');		}	}			public function getdata()	{		if(isset($_POST['id'],$_POST['type']) && $_POST['id'] > 0)		{			$this->lang->load($this->loginuser->lang, $this->loginuser->lang);			$this->config->set_item('language', $this->loginuser->lang);			$places = $this->Admin_mo->getwhere('places',array('parent'=>$_POST['id']));						if(!empty($places))			{				echo '<option value="0">'.lang($_POST['type']).'</option>';				foreach($places as $place)				{					echo '<option value="'.$place->id.'">'.$place->title.'</option>';				}			}			else echo 0;		}		else echo 0;	}	public function add()	{		if(strpos($this->loginuser->privileges, ',pcadd,') !== false && in_array('PC',$this->sections))		{		$data['admessage'] = '';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->lang, $this->loginuser->lang);		$this->config->set_item('language', $this->loginuser->lang);		$data['places'] = $this->Admin_mo->getwhere('places',array('parent'=>0));		$this->load->view('headers/place-add',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/place-add',$data);		$this->load->view('footers/place-add');		$this->load->view('messages');		}		else		{		$data['title'] = 'places';		$data['admessage'] = 'youhavenoprivls';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->lang, $this->loginuser->lang);		$this->config->set_item('language', $this->loginuser->lang);		$this->load->view('headers/places',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/messages',$data);		$this->load->view('footers/places');		$this->load->view('messages');		}	}		public function create()	{		if(strpos($this->loginuser->privileges, ',pcadd,') !== false && in_array('PC',$this->sections))		{		    $this->lang->load($this->loginuser->lang, $this->loginuser->lang);		$this->config->set_item('language', $this->loginuser->lang);		$this->form_validation->set_error_delimiters('<div class="alert alert-danger alert-dismissible fade in" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>', '</div>');		$this->form_validation->set_rules('title', 'lang:title' , 'trim|required|max_length[255]|is_unique[places.title]');		if($this->form_validation->run() == FALSE)		{			//$data['admessage'] = 'validation error';			//$_SESSION['time'] = time(); $_SESSION['message'] = 'inputnotcorrect';			$data['system'] = $this->mysystem;						$data['places'] = $this->Admin_mo->getwhere('places',array('parent'=>0));			$this->load->view('headers/place-add',$data);			$this->load->view('sidemenu',$data);			$this->load->view('topmenu',$data);			$this->load->view('admin/place-add',$data);			$this->load->view('footers/place-add');			$this->load->view('messages');		}		else		{			$set_arr = array('uid'=>$this->session->userdata('uid'), 'title'=>set_value('title'), 'active'=>set_value('active'), 'time'=>time());			if(set_value('parent2'))	$set_arr['parent'] = set_value('parent2');			elseif(set_value('parent1'))	$set_arr['parent'] = set_value('parent1');			else $set_arr['parent'] = set_value('parent');			$id = $this->Admin_mo->set('places', $set_arr);			if(empty($id))			{				$_SESSION['time'] = time(); $_SESSION['message'] = 'somthingwrong';				redirect('places/add', 'refresh');			}			else			{				$_SESSION['time'] = time(); $_SESSION['message'] = 'success';				redirect('places', 'refresh');			}		}		//redirect('places/add', 'refresh');		}		else		{		$data['title'] = 'places';		$data['admessage'] = 'youhavenoprivls';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->lang, $this->loginuser->lang);		$this->config->set_item('language', $this->loginuser->lang);		$this->load->view('headers/places',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/messages',$data);		$this->load->view('footers/places');		$this->load->view('messages');		}	}		public function edit($id)	{		if(strpos($this->loginuser->privileges, ',pcedit,') !== false && in_array('PC',$this->sections))		{		$id = abs((int)($id));		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->lang, $this->loginuser->lang);		$this->config->set_item('language', $this->loginuser->lang);		$data['myplace'] = $this->Admin_mo->getrow('places',array('id'=>$id));		if(!empty($data['myplace']))		{			$data['places'] = $this->Admin_mo->rate(				'T2.id, T2.title, T2.parent',				'(				SELECT					@r AS _id,					(SELECT @r := parent FROM places WHERE id = _id) AS parent,					@l := @l + 1 AS lvl				FROM					(SELECT @r := '.$id.', @l := 0) vars,					places h				WHERE @r <> 0) T1',				'JOIN places T2				ON T1._id = T2.id				ORDER BY T1.lvl DESC'			);						$data['countries'] = $this->Admin_mo->getwhere('places',array('parent'=>0));						if(isset($data['places'][1])) $data['governorates'] = $this->Admin_mo->getwhere('places',array('parent'=>$data['places'][1]->parent));						if(isset($data['places'][2])) $data['districts'] = $this->Admin_mo->getwhere('places',array('parent'=>$data['places'][2]->parent));			$this->load->view('headers/place-edit',$data);			$this->load->view('sidemenu',$data);			$this->load->view('topmenu',$data);			$this->load->view('admin/place-edit',$data);			$this->load->view('footers/place-edit');			$this->load->view('messages');		}		else		{			$data['title'] = 'places';			$data['admessage'] = 'youhavenoprivls';			$this->load->view('headers/places',$data);			$this->load->view('sidemenu',$data);			$this->load->view('topmenu',$data);			$this->load->view('admin/messages',$data);			$this->load->view('footers/places');			$this->load->view('messages');		}		}		else		{		$data['title'] = 'places';		$data['admessage'] = 'youhavenoprivls';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->lang, $this->loginuser->lang);		$this->config->set_item('language', $this->loginuser->lang);		$this->load->view('headers/places',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/messages',$data);		$this->load->view('footers/places');		$this->load->view('messages');		}	}		public function editplace($id)	{		if(strpos($this->loginuser->privileges, ',pcedit,') !== false && in_array('PC',$this->sections))		{		$id = abs((int)($id));		if($id != '')		{		    $this->lang->load($this->loginuser->lang, $this->loginuser->lang);			$this->config->set_item('language', $this->loginuser->lang);						$this->form_validation->set_error_delimiters('<div class="alert alert-danger alert-dismissible fade in" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>', '</div>');			$this->form_validation->set_rules('title', 'lang:title' , 'trim|required|max_length[255]');			if($this->form_validation->run() == FALSE)			{				$data['system'] = $this->mysystem;								$data['places'] = $this->Admin_mo->rate(					'T2.id, T2.title, T2.parent',					'(					SELECT						@r AS _id,						(SELECT @r := parent FROM places WHERE id = _id) AS parent,						@l := @l + 1 AS lvl					FROM						(SELECT @r := '.$id.', @l := 0) vars,						places h					WHERE @r <> 0) T1',					'JOIN places T2					ON T1._id = T2.id					ORDER BY T1.lvl DESC'				);							$data['countries'] = $this->Admin_mo->getwhere('places',array('parent'=>0));							if(isset($data['places'][1])) $data['governorates'] = $this->Admin_mo->getwhere('places',array('parent'=>$data['places'][1]->parent));							if(isset($data['places'][2])) $data['districts'] = $this->Admin_mo->getwhere('places',array('parent'=>$data['places'][2]->parent));								$this->load->view('headers/place-edit',$data);				$this->load->view('sidemenu',$data);				$this->load->view('topmenu',$data);				$this->load->view('admin/place-edit',$data);				$this->load->view('footers/place-edit');				$this->load->view('messages');			}			else			{				$update_array = array('uid'=>$this->session->userdata('uid'), 'title'=>set_value('title'), 'active'=>set_value('active'), 'time'=>time());				if(set_value('parent2'))	$update_array['parent'] = set_value('parent2');				elseif(set_value('parent1'))	$update_array['parent'] = set_value('parent1');				else $update_array['parent'] = set_value('parent');				if($update_array['parent'] != $id)				{					if($this->Admin_mo->exist('places','where id <> '.$id.' and parent = '.$update_array['parent'].' and title like "'.set_value('title').'"',''))					{						$_SESSION['time'] = time(); $_SESSION['message'] = 'nameexist';						redirect('places/edit/'.$id, 'refresh');					}					else					{						if($this->Admin_mo->update('places', $update_array, array('id'=>$id)))						{							$_SESSION['time'] = time(); $_SESSION['message'] = 'success';						}						else						{							$_SESSION['time'] = time(); $_SESSION['message'] = 'somthingwrong';						}					}				}								else				{					$_SESSION['time'] = time(); $_SESSION['message'] = 'nameexist';				}				redirect('places', 'refresh');			}		}		else		{			$data['admessage'] = 'Not Saved';			$_SESSION['time'] = time(); $_SESSION['message'] = 'somthingwrong';			redirect('places', 'refresh');		}		//redirect('places', 'refresh');		}		else		{		$data['title'] = 'places';		$data['admessage'] = 'youhavenoprivls';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->lang, $this->loginuser->lang);		$this->config->set_item('language', $this->loginuser->lang);		$this->load->view('headers/places',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/messages',$data);		$this->load->view('footers/places');		$this->load->view('messages');		}	}	public function del($id)	{		$id = abs((int)($id));		if(strpos($this->loginuser->privileges, ',pcdelete,') !== false && in_array('PC',$this->sections))		{		$place = $this->Admin_mo->getrow('places', array('id'=>$id));		if(!empty($place))		{						$places = $this->Admin_mo->getwhere('places', array('parent'=>$id));						if(empty($places))			{				$this->Admin_mo->del('places', array('id'=>$id));				$_SESSION['time'] = time(); $_SESSION['message'] = 'success';			}			else { $_SESSION['time'] = time(); $_SESSION['message'] = 'somthingwrong'; }			redirect('places', 'refresh');		}		else		{			$data['title'] = 'places';			$data['admessage'] = 'youhavenoprivls';			$data['system'] = $this->mysystem;			$this->lang->load($this->loginuser->lang, $this->loginuser->lang);			$this->config->set_item('language', $this->loginuser->lang);			$this->load->view('headers/places',$data);			$this->load->view('sidemenu',$data);			$this->load->view('topmenu',$data);			$this->load->view('admin/messages',$data);			$this->load->view('footers/places');			$this->load->view('messages');		}		}		else		{		$data['title'] = 'places';		$data['admessage'] = 'youhavenoprivls';		$data['system'] = $this->mysystem;		$this->lang->load($this->loginuser->lang, $this->loginuser->lang);		$this->config->set_item('language', $this->loginuser->lang);		$this->load->view('headers/places',$data);		$this->load->view('sidemenu',$data);		$this->load->view('topmenu',$data);		$this->load->view('admin/messages',$data);		$this->load->view('footers/places');		$this->load->view('messages');		}	}}